# Серверная часть рекомендательной системы для предсказания диагноза по протоколу осмотра

## Архитектура приложения
![Диаграмма компонентов](./components.png)

### Диаграмма компонентов
**FastAPI сервер** - Серверное приложение, обработка запросов

**Vector Database** - Векторная база данных, хранит эмбеддинги для соответствующих документов.
Используется для векторного поиска по документам.

**LLM Module** - Языковая модель, генерация ответа, на основе данных, полученных от векторной базы данных

**Embedding Function** - Модель для создания эмбеддингов. Модель которая используется в Vector Database для создания эмеддингов из текстовых данных

**Text Preproseccing** - Предобработка текста. Функция для предобработки текста.

**Data Folder** - Директория со всеми документами, используемыми в системе, различные форматы текстовых данных, которые будут переведены в векторное представление и помещены в векторную базу данных.

**AdaptersData** - Директория с адаптерами для разных форматов данных, хранимых в Data Folder. Получение текстовых данных из различных форматов, для представления в удобной форме, для передачи в векторную базу данных.

### Описание подхода
* Данное решение основано на генерации ответа с дополненным извлечением. При поступлении данных с клиента, формируется запрос и поступает в векторную базу данных, запрос преобразуется в эмбеддинг, с помощью **Embedding Function** и в векторной базе данных осуществляется поиск наиболее близких векторов, в качестве меры сходства используется косинусное подобие. 
Из векторной базы данных извлекается 10 найденных объектов. Формируется промпт и передается в языковую модель.
* Модель генерирует ответ, после чего ответ отправляется клиенту. Ответ от модели — диагноз, который определила модель, на основе данных, переданных в промпт.
* Чтобы удостовериться в результате модели на клиент отправляются извлеченные объекты из векторной базы данных.

* Векторная база данных содержит текстовые данные извлеченные из документов, содержащихся в **Data Folder**, с помощью **AdaptersData**. Так как форматы данных могут быть разные, для каждого формата необходимо написать свой адаптер, для извлечения. В данной работе представленно извлечение только для двух частных случаев документов, представленных в **Data Folder**.

## Требования для запуска
Перед запуском необходимо установить 
* **CUDA**, перейти по ссылке и выбрать соответствующую конфигурацию и установить
https://developer.nvidia.com/cuda-downloads

* **CUDA для PyTorch**, необходимо перейти по ссылке, выбрать соответствующую конфигурацию и установить
https://pytorch.org/get-started/locally/

После установки
Клонировать репозиторий
```
git clone https://github.com/nik9ta5/appserverRecSys.git
```

Перейти в папку с проектом
```
cd file_name
```

Установить необходимые зависимости (выполнить команду представленную ниже)
```
pip install -r requirements.txt
```

## Запуск
Точка входа в приложение - ./app/main.py 

Принимаемые параметры:
* --fullVDB - заполнение векторной базы данных
* --delVDB - удаление всего содержимого в векторной базе данных

Перейти в папку **app** и запустить приложение
```
cd app
python main.py --fullVDB
```

## Отслеживаемые пути
Приложение работает локально по адрессу: http://127.0.0.1:5000
При необходимости можно изменить в файле main.py

### Передача данных с клиента
**POST** http://127.0.0.1:5000/preddiagnose
```
{
  "visits" : "",
  "complaint" : "",
  "anamnesis" : "",
  "objective_status" : "",
  "diagnosis_details" : "",
  "recommendations" : ""
}
```
